---
- name: Create AWS FSx for ONTAP File System
  hosts: localhost
  gather_facts: false
  vars_files:
    - "{{ playbook_dir }}/vars/fsx-ontap-vars.yml"
  tasks:
    - name: Skip creation if deletion is requested
      ansible.builtin.meta: end_play
      when: delete_resources | default(false)

    - name: Discover AWS values
      ansible.builtin.include_role:
        name: aws_ocp_discovery

    - name: Display AWS and Cluster discovery results
      ansible.builtin.debug:
        msg:
          - "Cluster lookup results:"
          - "  ocp_infra_name: {{ ocp_infra_name }}"
          - "  ocp_platform: {{ ocp_platform }}"
          - "  ocp_aws_region: {{ ocp_aws_region }}"
          - "  ocp_app_domain: {{ ocp_app_domain }}"
          - "  ocp_version: {{ ocp_version }}"
          - "  ocp_base_domain: {{ ocp_base_domain }}"
          - "  ocp_cluster_name: {{ ocp_base_domain }}"
          - "VPC Lookup Results:"
          - "  aws_vpc_id: {{ aws_vpc_id }}"
          - "Subnet Lookup Results:"
          - "  aws_vpc_private_subnet_ids: {{ aws_vpc_private_subnet_ids }}"
          - "Route Table Lookup Results:"
          - "  aws_vpc_route_table_ids: {{ aws_vpc_route_table_ids }}"

    - name: Load values-global.yaml to get pattern name
      ansible.builtin.set_fact:
        values_global_data: "{{ lookup('file', playbook_dir + '/../values-global.yaml') | from_yaml }}"
      when: not (delete_resources | default(false))

    - name: Extract pattern name from values-global
      ansible.builtin.set_fact:
        pattern_name: "{{ values_global_data.global.pattern | default('ocpvdr') }}"
      when: not (delete_resources | default(false))

    - name: Check if ~/.fsx file exists
      ansible.builtin.stat:
        path: "{{ '~/.fsx' | expanduser }}"
      register: fsx_file_stat
      when: not (delete_resources | default(false))

    - name: Read password from ~/.fsx file
      ansible.builtin.slurp:
        src: "{{ '~/.fsx' | expanduser }}"
      register: fsx_file_content
      when:
        - not (delete_resources | default(false))
        - fsx_file_stat.stat.exists | default(false)
      failed_when: false

    - name: Extract password from ~/.fsx file
      ansible.builtin.set_fact:
        fsx_password_from_file: "{{ fsx_file_content.content | b64decode | string | trim }}"
      when:
        - not (delete_resources | default(false))
        - fsx_file_stat.stat.exists | default(false)
        - fsx_file_content is defined
        - fsx_file_content.content is defined

    - name: Override fsx_admin_password and svm_admin_password from ~/.fsx file
      ansible.builtin.set_fact:
        fsx_admin_password: "{{ fsx_password_from_file }}"
        svm_admin_password: "{{ fsx_password_from_file }}"
      when:
        - not (delete_resources | default(false))
        - fsx_file_stat.stat.exists | default(false)
        - fsx_password_from_file is defined
        - fsx_password_from_file | length > 0

    - name: Debug password from file
      ansible.builtin.debug:
        msg:
          - "fsx_password_from_file: '{{ fsx_password_from_file | default('NOT SET') }}'"
          - "fsx_admin_password: '{{ fsx_admin_password | default('NOT SET') }}'"
          - "svm_admin_password: '{{ svm_admin_password | default('NOT SET') }}'"
          - "fsx_file_stat.stat.exists: {{ fsx_file_stat.stat.exists | default(false) }}"
      when: not (delete_resources | default(false))

    - name: Debug final password values
      ansible.builtin.debug:
        var: fsx_admin_password
      when: not (delete_resources | default(false))

    - name: Debug final svm password values
      ansible.builtin.debug:
        var: svm_admin_password
      when: not (delete_resources | default(false))

    - name: Validate fsx_admin_password is set
      ansible.builtin.fail:
        msg: >
          fsx_admin_password is required but not found.
          Please either:
          1. Create ~/.fsx file with the password, OR
          2. Pass it via -e fsx_admin_password=<password> on the command line.
      when:
        - not (delete_resources | default(false))
        - (fsx_admin_password is not defined or fsx_admin_password == '' or fsx_admin_password == 'null' or fsx_admin_password == None)

    - name: Validate svm_admin_password is set
      ansible.builtin.fail:
        msg: >
          svm_admin_password is required but not found.
          Please either:
          1. Create ~/.fsx file with the password, OR
          2. Pass it via -e svm_admin_password=<password> on the command line.
      when:
        - not (delete_resources | default(false))
        - (svm_admin_password is not defined or svm_admin_password == '' or svm_admin_password == 'null' or svm_admin_password == None)

    - name: Create FSx ONTAP filesystem
      ansible.builtin.include_role:
        name: fsx_ontap

    - name: Update tridentFSX.iscsi.mgmtLIF in values-trident.yaml
      ansible.builtin.replace:
        path: "{{ playbook_dir }}/../overrides/values-trident.yaml"
        regexp: '^(\s{4})mgmtLIF:\s+.*'
        replace: '\1mgmtLIF: {{ svm_mgmt_dns_name }}'
      when:
        - not (delete_resources | default(false))
        - svm_mgmt_dns_name is defined
        - svm_mgmt_dns_name != ""

    - name: Update tridentFSX.iscsi.svm in values-trident.yaml
      ansible.builtin.replace:
        path: "{{ playbook_dir }}/../overrides/values-trident.yaml"
        regexp: '^(\s{4})svm:\s+.*'
        replace: '\1svm: {{ svm_name_result }}'
      when:
        - not (delete_resources | default(false))
        - svm_name_result is defined
        - svm_name_result != ""

    - name: Display updated values
      ansible.builtin.debug:
        msg:
          - "Updated values-trident.yaml:"
          - "  mgmtLIF: {{ svm_mgmt_dns_name | default('not set') }}"
          - "  svm: {{ svm_name_result | default('not set') }}"
      when: not (delete_resources | default(false))

- name: Delete FSx ONTAP Resources
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Discover AWS values
      ansible.builtin.include_role:
        name: aws_ocp_discovery

    - name: Delete FSx ONTAP resources
      ansible.builtin.include_role:
        name: fsx_ontap
        tasks_from: delete
      when: delete_resources | default(false)
