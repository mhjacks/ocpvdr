---
- name: Display resolved network configuration
  ansible.builtin.debug:
    msg:
      - "Resolved Network Configuration:"
      - "  VPC ID: {{ aws_vpc_id }}"
      - "  Subnet IDs: {{ aws_vpc_private_subnet_ids }}"
      - "  Route Table IDs: {{ aws_vpc_route_table_ids }}"

- name: Check if security group already exists
  amazon.aws.ec2_security_group_info:
    region: "{{ ocp_aws_region }}"
    filters:
      vpc-id: "{{ aws_vpc_id }}"
      group-name: "{{ file_system_name }}-sg"
  register: existing_sg_check
  changed_when: false

- name: Create security group for FSx ONTAP
  amazon.aws.ec2_security_group:
    name: "{{ file_system_name }}-sg"
    description: "Security Group for FSx for NetApp ONTAP File Storage Access"
    vpc_id: "{{ aws_vpc_id }}"
    region: "{{ ocp_aws_region }}"
    rules:
      # ICMP
      - proto: icmp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: -1
        to_port: -1
      # SSH
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 22
        to_port: 22
      # NFS/RPC
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 111
        to_port: 111
      - proto: udp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 111
        to_port: 111
      # SMB/CIFS
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 135
        to_port: 135
      - proto: udp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 135
        to_port: 135
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 139
        to_port: 139
      - proto: udp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 137
        to_port: 137
      - proto: udp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 139
        to_port: 139
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 445
        to_port: 445
      # SNMP
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 161
        to_port: 161
      - proto: udp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 161
        to_port: 161
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 162
        to_port: 162
      - proto: udp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 162
        to_port: 162
      # HTTPS
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 443
        to_port: 443
      # NFS
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 2049
        to_port: 2049
      - proto: udp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 2049
        to_port: 2049
      # iSCSI
      - proto: udp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 3260
        to_port: 3260
      # ONTAP Management
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 4045
        to_port: 4045
      - proto: udp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 4045
        to_port: 4045
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 4046
        to_port: 4046
      - proto: udp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 4046
        to_port: 4046
      - proto: udp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 4049
        to_port: 4049
      # Additional ONTAP ports
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 635
        to_port: 635
      - proto: udp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 635
        to_port: 635
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 749
        to_port: 749
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 11104
        to_port: 11104
      - proto: tcp
        cidr_ip: "{{ allowed_cidr }}"
        from_port: 11105
        to_port: 11105
    resource_tags: "{{ sg_resource_tags }}"
  register: security_group
  when: existing_sg_check.security_groups | default([]) | length == 0

- name: Get security group ID from existing or created
  ansible.builtin.set_fact:
    security_group_id: "{{ existing_sg_check.security_groups[0].group_id
      if (existing_sg_check.security_groups | default([]) | length > 0)
      else security_group.group_id }}"

- name: Check if FSx file system already exists
  ansible.builtin.command: >
    aws fsx describe-file-systems
    --region {{ ocp_aws_region }}
    --filters "Name=file-system-type,Values=ONTAP"
    --output json
  register: existing_fsx_check
  changed_when: false
  failed_when: false

- name: Parse FSx file systems JSON
  ansible.builtin.set_fact:
    fsx_file_systems: "{{ (existing_fsx_check.stdout | from_json).FileSystems | default([]) }}"
  when: >
    existing_fsx_check.rc == 0 and
    existing_fsx_check.stdout is defined and
    existing_fsx_check.stdout | trim != '' and
    existing_fsx_check.stdout | trim | length > 0

- name: Set empty file systems list if no output or error
  ansible.builtin.set_fact:
    fsx_file_systems: []
  when: >
    existing_fsx_check.rc != 0 or
    existing_fsx_check.stdout is not defined or
    existing_fsx_check.stdout | trim == '' or
    existing_fsx_check.stdout | trim | length == 0

- name: Find FSx file system by name tag
  ansible.builtin.set_fact:
    existing_fsx_id: "{{ item.FileSystemId }}"
  loop: "{{ fsx_file_systems | default([]) }}"
  when: >
    (existing_fsx_id is not defined or existing_fsx_id == '') and
    item.Tags is defined and
    item.Tags | selectattr('Key', 'equalto', 'Name') | selectattr('Value', 'equalto', file_system_name) | list | length > 0
  loop_control:
    label: "{{ item.FileSystemId }}"

- name: Set existing FSx file system ID (default empty if not found)
  ansible.builtin.set_fact:
    existing_fsx_id: ""
  when: existing_fsx_id is not defined

- name: Debug FSx existence check
  ansible.builtin.debug:
    msg:
      - "FSx Existence Check:"
      - "  File System Name: {{ file_system_name }}"
      - "  Existing FSx ID: {{ existing_fsx_id | default('NOT FOUND') }}"
      - "  Will create new filesystem: {{ (existing_fsx_id | default('')) == '' }}"
      - "  Will skip creation: {{ (existing_fsx_id | default('')) != '' }}"

- name: Fail if we do not have two subnet IDs
  ansible.builtin.fail:
    msg: "FSx for ONTAP Multi-AZ config requires exactly two subnet IDs. We have {{ aws_vpc_private_subnet_ids }}"
  when: aws_vpc_private_subnet_ids | length != 2

- name: Create FSx for ONTAP file system
  ansible.builtin.shell: |
    aws fsx create-file-system \
    --region {{ ocp_aws_region }} \
    --file-system-type ONTAP \
    --storage-capacity {{ storage_capacity }} \
    --storage-type {{ storage_type }} \
    --subnet-ids {{ aws_vpc_private_subnet_ids | join(' ') }} \
    --security-group-ids {{ security_group_id }} \
    --ontap-configuration '{
      "DeploymentType": "{{ deployment_type }}",
      "PreferredSubnetId": "{{ aws_vpc_private_subnet_ids | first }}",
      "RouteTableIds": {{ aws_vpc_route_table_ids | to_json }},
      "ThroughputCapacity": {{ throughput_capacity }},
      "WeeklyMaintenanceStartTime": "{{ weekly_maintenance_time }}",
      "FsxAdminPassword": "{{ fsx_admin_password }}",
      "AutomaticBackupRetentionDays": 3,
      "DailyAutomaticBackupStartTime": "01:00",
      "DiskIopsConfiguration": {"Mode": "AUTOMATIC"}
    }' \
    --tags \
      Key=Name,Value={{ file_system_name }} \
      Key=Environment,Value={{ fsx_resource_tags.Environment }} \
      Key=ManagedBy,Value={{ fsx_resource_tags.ManagedBy }} \
    --output json
  register: fsx_create_result
  when: existing_fsx_id | default('') == ''
  changed_when: true
  environment:
    AWS_DEFAULT_REGION: "{{ ocp_aws_region }}"

- name: Get existing FSx file system ID
  ansible.builtin.set_fact:
    fsx_filesystem_id: "{{ existing_fsx_id }}"
  when: existing_fsx_id | default('') != ''

- name: Extract FSx file system ID from creation result
  ansible.builtin.set_fact:
    fsx_filesystem_id: "{{ (fsx_create_result.stdout | from_json).FileSystem.FileSystemId }}"
  when: (existing_fsx_id | default('') == '') and fsx_create_result is defined

- name: Wait for FSx file system to be available
  ansible.builtin.command: >
    aws fsx describe-file-systems
    --region {{ ocp_aws_region }}
    --file-system-ids {{ fsx_filesystem_id }}
    --query "FileSystems[0].Lifecycle"
    --output text
  changed_when: false
  register: fsx_status
  until: fsx_status.stdout == "AVAILABLE"
  retries: 60
  delay: 30
  when: (existing_fsx_id | default('') == '') and fsx_create_result is defined

- name: Get FSx file system details
  ansible.builtin.command: >
    aws fsx describe-file-systems
    --region {{ ocp_aws_region }}
    --file-system-ids {{ fsx_filesystem_id }}
    --output json
  register: fsx_details
  changed_when: false

- name: Set FSx file system facts
  ansible.builtin.set_fact:
    fsx_filesystem_data: "{{ (fsx_details.stdout | from_json).FileSystems[0] }}"

- name: Extract FSx DNS name
  ansible.builtin.set_fact:
    fsx_dns_name: "{{ fsx_filesystem_data.DNSName | default(fsx_filesystem_data.OntapConfiguration.Endpoints.Management.DNSName | default('N/A')) }}"
  when: fsx_filesystem_data is defined

- name: Display FSx File System ID
  ansible.builtin.debug:
    msg: "FSx File System ID: {{ fsx_filesystem_id }}"

- name: Check if SVM already exists
  ansible.builtin.command: >
    aws fsx describe-storage-virtual-machines
    --region {{ ocp_aws_region }}
    --file-system-id {{ fsx_filesystem_id }}
    --query "StorageVirtualMachines[?Name=='{{ svm_name }}'].StorageVirtualMachineId"
    --output text
  register: existing_svm_check
  changed_when: false
  failed_when: false

- name: Set existing SVM ID
  ansible.builtin.set_fact:
    existing_svm_id: "{{ existing_svm_check.stdout.strip() if existing_svm_check.stdout is defined and existing_svm_check.stdout.strip() != '' else '' }}"

- name: Create Storage Virtual Machine (SVM)
  ansible.builtin.command: >
    aws fsx create-storage-virtual-machine
    --region {{ ocp_aws_region }}
    --file-system-id {{ fsx_filesystem_id }}
    --name {{ svm_name }}
    --root-volume-security-style {{ root_volume_security_style }}
    --svm-admin-password {{ svm_admin_password }}
    --output json
  register: svm_create_result
  when: existing_svm_id == ""
  changed_when: true
  environment:
    AWS_DEFAULT_REGION: "{{ ocp_aws_region }}"

- name: Get existing SVM ID
  ansible.builtin.set_fact:
    svm_id: "{{ existing_svm_id }}"
  when: existing_svm_id != ""

- name: Extract SVM ID from creation result
  ansible.builtin.set_fact:
    svm_id: "{{ (svm_create_result.stdout | from_json).StorageVirtualMachine.StorageVirtualMachineId }}"
  when: existing_svm_id == "" and svm_create_result is defined

- name: Wait for SVM to be created
  ansible.builtin.command: >
    aws fsx describe-storage-virtual-machines
    --region {{ ocp_aws_region }}
    --storage-virtual-machine-ids {{ svm_id }}
    --query "StorageVirtualMachines[0].Lifecycle"
    --output text
  register: svm_status
  until: svm_status.stdout == "CREATED"
  retries: 20
  delay: 30
  when: existing_svm_id == "" and svm_create_result is defined
  changed_when: false

- name: Get SVM details
  ansible.builtin.command: >
    aws fsx describe-storage-virtual-machines
    --region {{ ocp_aws_region }}
    --storage-virtual-machine-ids {{ svm_id }}
    --output json
  register: svm_details
  changed_when: false

- name: Set SVM facts
  ansible.builtin.set_fact:
    svm_uuid: "{{ (svm_details.stdout | from_json).StorageVirtualMachines[0].UUID }}"
    svm_name_result: "{{ (svm_details.stdout | from_json).StorageVirtualMachines[0].Name }}"
    svm_mgmt_dns_name: "{{ (svm_details.stdout | from_json).StorageVirtualMachines[0].Endpoints.Management.DNSName | default('') }}"

- name: Display SVM Information
  ansible.builtin.debug:
    msg:
      - "SVM ID: {{ svm_id }}"
      - "SVM Name: {{ svm_name_result }}"
      - "SVM UUID: {{ svm_uuid }}"

- name: Check if FSx Admin secret exists
  ansible.builtin.command: >
    aws secretsmanager describe-secret
    --region {{ ocp_aws_region }}
    --secret-id {{ file_system_name }}-FsxAdminPassword
    --query "ARN"
    --output text
  register: fsx_secret_check
  changed_when: false
  failed_when: false

- name: Create Secrets Manager secret for FSx Admin Password
  community.aws.secretsmanager_secret:
    region: "{{ aws_region }}"
    name: "{{ file_system_name }}-FsxAdminPassword"
    description: "FSx Admin Password for {{ file_system_name }}"
    secret: "{\"username\":\"fsxadmin\",\"password\":\"{{ fsx_admin_password }}\"}"
    secret_type: string
    resource_tags:
      Name: "{{ file_system_name }}"
      Environment: "{{ fsx_resource_tags.Environment }}"
      ManagedBy: "{{ fsx_resource_tags.ManagedBy }}"
  register: fsx_secret
  when: >
    create_secrets | default(true) and
    (fsx_secret_check.stdout == "" or fsx_secret_check.stdout == "None")
  failed_when: false

- name: Warn if FSx secret creation failed
  ansible.builtin.debug:
    msg:
      - "WARNING: Failed to create FSx Admin secret in AWS Secrets Manager."
      - "Error: {{ fsx_secret.msg | default('Unknown error') }}"
      - "This is non-fatal - the FSx filesystem was created successfully."
      - "You can manually create the secret or set create_secrets: false to skip this step."
  when: >
    create_secrets | default(true) and
    (fsx_secret_check.stdout == "" or fsx_secret_check.stdout == "None") and
    fsx_secret is defined and
    fsx_secret.failed | default(false)

- name: Check if SVM Admin secret exists
  ansible.builtin.command: >
    aws secretsmanager describe-secret
    --region {{ aws_region }}
    --secret-id {{ file_system_name }}-SVMAdminPassword
    --query "ARN"
    --output text
  register: svm_secret_check
  changed_when: false
  failed_when: false

- name: Create Secrets Manager secret for SVM Admin Password
  community.aws.secretsmanager_secret:
    region: "{{ aws_region }}"
    name: "{{ file_system_name }}-SVMAdminPassword"
    description: "SVM Admin Password for {{ file_system_name }}"
    secret: "{\"username\":\"vsadmin\",\"password\":\"{{ svm_admin_password }}\"}"
    secret_type: string
    resource_tags:
      Name: "{{ file_system_name }}"
      Environment: "{{ fsx_resource_tags.Environment }}"
      ManagedBy: "{{ fsx_resource_tags.ManagedBy }}"
  register: svm_secret
  when: >
    create_secrets | default(true) and
    (svm_secret_check.stdout == "" or svm_secret_check.stdout == "None")
  failed_when: false

- name: Warn if SVM secret creation failed
  ansible.builtin.debug:
    msg:
      - "WARNING: Failed to create SVM Admin secret in AWS Secrets Manager."
      - "Error: {{ svm_secret.msg | default('Unknown error') }}"
      - "This is non-fatal - the FSx filesystem was created successfully."
      - "You can manually create the secret or set create_secrets: false to skip this step."
  when: >
    create_secrets | default(true) and
    (svm_secret_check.stdout == "" or svm_secret_check.stdout == "None") and
    svm_secret is defined and
    svm_secret.failed | default(false)

- name: Get or set FSx Admin secret ARN
  ansible.builtin.set_fact:
    fsx_secret_arn: "{{ fsx_secret_check.stdout
      if (fsx_secret_check.stdout != '' and fsx_secret_check.stdout != 'None')
      else (fsx_secret.secret.arn | default('')
        if (fsx_secret is defined and fsx_secret.secret is defined)
        else '') }}"

- name: Get or set SVM Admin secret ARN
  ansible.builtin.set_fact:
    svm_secret_arn: "{{ svm_secret_check.stdout
      if (svm_secret_check.stdout != '' and svm_secret_check.stdout != 'None')
      else (svm_secret.secret.arn | default('')
        if (svm_secret is defined and svm_secret.secret is defined)
        else '') }}"

- name: Display Output Summary
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "FSx for ONTAP Deployment Complete"
      - "=========================================="
      - "File System ID: {{ fsx_filesystem_id }}"
      - "File System DNS Name: {{ fsx_dns_name }}"
      - "SVM ID: {{ svm_id }}"
      - "SVM Name: {{ svm_name_result }}"
      - "Security Group ID: {{ security_group_id }}"
      - "FSx Admin Secret ARN: {{ fsx_secret_arn }}"
      - "SVM Admin Secret ARN: {{ svm_secret_arn }}"
      - "=========================================="
